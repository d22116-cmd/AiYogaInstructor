<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AI Yoga - Common Yoga Protocol</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <style>
        body { margin: 0; background: #020617; color: white; font-family: sans-serif; overflow: hidden; }
        #app { position: relative; width: 100vw; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        #ui { position: absolute; bottom: 30px; background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(10px); padding: 25px; border-radius: 20px; width: 400px; text-align: center; z-index: 10; border: 1px solid rgba(255,255,255,0.1); }
        .score { font-size: 3em; font-weight: 800; color: #10b981; }
        button { background: #10b981; border: none; padding: 18px 45px; border-radius: 50px; font-weight: bold; cursor: pointer; color: white; font-size: 1.2em; transition: 0.3s; }
        #msg { color: #94a3b8; margin: 15px 0; font-size: 1.1em; height: 50px; }
    </style>
</head>
<body>

<div id="app">
    <video id="input_video" style="display:none" playsinline></video>
    <canvas id="output_canvas"></canvas>

    <div id="ui">
        <div id="pose-name" style="font-weight: bold; font-size: 1.5em;">CYP Yoga Guide</div>
        <div id="score" class="score">--</div>
        <p id="msg">Ensure you are in a bright room and stand 6-8 feet away.</p>
        <button id="start-btn">START SESSION</button>
    </div>
</div>

<script>
const videoElement = document.getElementById('input_video');
const canvasElement = document.getElementById('output_canvas');
const canvasCtx = canvasElement.getContext('2d');
const scoreEl = document.getElementById('score');
const msgEl = document.getElementById('msg');
const startBtn = document.getElementById('start-btn');

const CYP_ASANAS = [
    { name: "Tādāsana", intro: "Let's begin with Tādāsana. Focus on a point in front of you.", caution: "Avoid if you have acute migraine or low blood pressure.", duration: 10 },
    { name: "Vṛkṣāsana", intro: "Next is Vṛkṣāsana. Lift your leg and place the foot on your thigh.", caution: "Avoid if you have vertigo.", duration: 15 }
];

let currentIndex = 0;
let isPracticing = false;

// Humanistic Voice Engine
function speak(text, callback) {
    window.speechSynthesis.cancel(); // Reset audio
    const speech = new SpeechSynthesisUtterance(text);
    speech.rate = 0.85; 
    speech.onend = callback;
    window.speechSynthesis.speak(speech);
}

// Logic to check "Vrikshasana"
function checkPose(landmarks) {
    // Basic stability: check if one ankle (27/28) is significantly higher than the other
    const leftAnkleY = landmarks[27].y;
    const rightAnkleY = landmarks[28].y;
    return Math.abs(leftAnkleY - rightAnkleY) > 0.1;
}

async function runSession() {
    const asana = CYP_ASANAS[currentIndex];
    document.getElementById('pose-name').innerText = asana.name;
    
    speak(`${asana.name}. ${asana.intro}. Caution: ${asana.caution}. Stand in position now.`, () => {
        isPracticing = true;
        let count = asana.duration;
        const timer = setInterval(() => {
            if (count > 0) {
                msgEl.innerText = `Holding for ${count}s...`;
                count--;
            } else {
                clearInterval(timer);
                isPracticing = false;
                speak(`Excellent. Moving to the next pose.`, () => {
                    currentIndex++;
                    if (currentIndex < CYP_ASANAS.length) runSession();
                    else speak("Namaste. Protocol complete.");
                });
            }
        }, 1000);
    });
}

function onResults(results) {
    // Set canvas dimensions to match browser window
    canvasElement.width = window.innerWidth;
    canvasElement.height = window.innerHeight;

    canvasCtx.save();
    canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
    
    // Draw the video frame to the canvas
    canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

    if (results.poseLandmarks) {
        // Draw the "Skeleton" overlay
        drawConnectors(canvasCtx, results.poseLandmarks, POSE_CONNECTIONS, {color: '#00FF00', lineWidth: 4});
        drawLandmarks(canvasCtx, results.poseLandmarks, {color: '#FF0000', lineWidth: 2});

        if (isPracticing) {
            const isCorrect = checkPose(results.poseLandmarks);
            scoreEl.innerText = isCorrect ? "95%" : "40%";
        }
    }
    canvasCtx.restore();
}

const pose = new Pose({
    locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`
});

pose.setOptions({ modelComplexity: 1, smoothLandmarks: true, minDetectionConfidence: 0.5 });
pose.onResults(onResults);

const camera = new Camera(videoElement, {
    onFrame: async () => { await pose.send({image: videoElement}); },
    width: 1280, height: 720
});

startBtn.onclick = () => {
    startBtn.style.display = 'none';
    camera.start(); // Start camera after click
    runSession();   // Start audio after click
};
</script>
</body>
</html>
